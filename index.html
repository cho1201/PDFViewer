<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PDF Reader (Local + Drive)</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { margin:0; font-family:Arial; background:#fff; color:#000; transition:0.3s; }
    body.dark-mode { background:#121212; color:#eee; }
    header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f0f0f0; }
    body.dark-mode header { background:#1e1e1e; }
    h1 { margin:0; font-size:18px; flex:1; text-align:center; }
    #pdf-controls { display:flex; align-items:center; gap:10px; }
    #pdf-viewer { text-align:center; margin-top:10px; position:relative; overflow:hidden; height:80vh; }
    .canvas-wrapper { display:inline-block; position:absolute; top:0; left:0; width:100%; height:100%; }
    canvas { border:1px solid #ccc; max-width:100%; }
    #slider { width:300px; margin:10px auto; }
    button { padding:5px 10px; cursor:pointer; }
    #drive-file-list { margin-top:10px; }
  </style>
</head>
<body>

<header>
  <input type="file" id="file-input" accept="application/pdf">
  <h1 id="pdf-title">PDF Reader</h1>
  <div id="pdf-controls">
    <button id="prev-page">이전</button>
    <button id="next-page">다음</button>
    <span id="page-info"></span>
    <button id="zoom-in">+</button>
    <button id="zoom-out">-</button>
    <button id="rotate">회전</button>
    <button id="toggle-mode">다크/화이트</button>
    <button id="fullscreen">전체화면</button>
    <button id="drive-login">Drive 로그인</button>
  </div>
</header>

<div id="slider"></div>
<div id="pdf-viewer"></div>
<div id="drive-file-list"></div>

<script>
let pdfDoc = null, currentPage = 1, scale = 1.2, rotation = 0, fileName = '';

// === PDF 렌더링 함수 ===
function renderPage(num, direction=null){
  pdfDoc.getPage(num).then(page=>{
    const viewport = page.getViewport({scale, rotation});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width; canvas.height = viewport.height;
    page.render({canvasContext:ctx, viewport}).promise.then(()=>{
      const wrapper = $('<div class="canvas-wrapper"></div>').append(canvas);
      $('#pdf-viewer').append(wrapper);
      if(direction){
        let offset = direction==='next'?$('#pdf-viewer').width():-$('#pdf-viewer').width();
        wrapper.css({left:offset, opacity:0});
        $('#pdf-viewer .canvas-wrapper').not(wrapper).animate({left:-offset,opacity:0},400,function(){ $(this).remove(); });
        wrapper.animate({left:0, opacity:1},400);
      } else { $('#pdf-viewer').empty().append(wrapper); }
      $('#page-info').text(num+' / '+pdfDoc.numPages);
      $('#slider').slider('value',num);
    });
  });
}

function queueRenderPage(num, direction=null){
  if(num>=1 && num<=pdfDoc.numPages){ currentPage=num; renderPage(num,direction); }
}

// === 로컬 파일 이벤트 ===
$('#file-input').on('change', e=>{
  const file = e.target.files[0];
  if(file && file.type==='application/pdf'){
    fileName=file.name; $('#pdf-title').text(fileName);
    const reader = new FileReader();
    reader.onload=function(){ 
      const typedarray=new Uint8Array(this.result);
      pdfjsLib.getDocument(typedarray).promise.then(pdf=>{
        pdfDoc=pdf; currentPage=1;
        $('#slider').slider({min:1,max:pdf.numPages,value:1,slide:(e,ui)=>{queueRenderPage(ui.value, ui.value>currentPage?'next':'prev');}});
        renderPage(1);
      });
    };
    reader.readAsArrayBuffer(file);
  }
});

// === UI 버튼 이벤트 ===
$('#prev-page').click(()=>{ if(currentPage>1) queueRenderPage(currentPage-1,'prev'); });
$('#next-page').click(()=>{ if(currentPage<pdfDoc.numPages) queueRenderPage(currentPage+1,'next'); });
$('#zoom-in').click(()=>{ scale+=0.2; renderPage(currentPage); });
$('#zoom-out').click(()=>{ if(scale>0.4){ scale-=0.2; renderPage(currentPage); }});
$('#rotate').click(()=>{ rotation=(rotation+90)%360; renderPage(currentPage); });
$('#toggle-mode').click(()=>{$('body').toggleClass('dark-mode');});
$('#fullscreen').click(()=>{ const el=document.getElementById('pdf-viewer'); if(el.requestFullscreen) el.requestFullscreen(); });

// === 키보드 & 클릭 ===
$(document).on('keydown', e=>{
  if(e.key==='ArrowLeft' && currentPage>1) queueRenderPage(currentPage-1,'prev');
  else if(e.key==='ArrowRight' && currentPage<pdfDoc.numPages) queueRenderPage(currentPage+1,'next');
});
$('#pdf-viewer').on('click', e=>{
  const w=$(this).width(), x=e.pageX-$(this).offset().left, m=w*0.15;
  if(x<m && currentPage>1) queueRenderPage(currentPage-1,'prev');
  else if(x>w-m && currentPage<pdfDoc.numPages) queueRenderPage(currentPage+1,'next');
});

// === Google Drive API 설정 ===
const CLIENT_ID = '509467880947-qo524am67cois4q11a7noegf2amp5qrd.apps.googleusercontent.com';
const API_KEY = 'AIzaSyD7ii_yArIUnhQtRV4x6Y2QFOY9qNn5tdk';
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

function handleClientLoad(){ gapi.load('client:auth2', initClient); }
function initClient(){
  gapi.client.init({apiKey:API_KEY, clientId:CLIENT_ID, discoveryDocs:DISCOVERY_DOCS, scope:SCOPES})
    .then(()=>{ gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus); updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get()); });
}

function updateSigninStatus(isSignedIn){ if(isSignedIn) listFiles(); else gapi.auth2.getAuthInstance().signIn(); }

function listFiles(){
  gapi.client.drive.files.list({pageSize:20, fields:"files(id,name,mimeType)"}).then(res=>{
    const files=res.result.files;
    const list=$('#drive-file-list').empty();
    files.forEach(f=>{
      if(f.mimeType==='application/pdf'){
        $('<button>').text(f.name).click(()=>loadPdfFromDrive(f.id,f.name)).appendTo(list);
      }
    });
  });
}

function loadPdfFromDrive(fileId,name){
  gapi.client.drive.files.get({fileId:fileId, alt:'media'}).then(res=>{
    const typedarray=new Uint8Array(res.body);
    pdfjsLib.getDocument(typedarray).promise.then(pdf=>{
      pdfDoc=pdf; currentPage=1; fileName=name;
      $('#pdf-title').text(name);
      $('#slider').slider({min:1,max:pdf.numPages,value:1,slide:(e,ui)=>{queueRenderPage(ui.value, ui.value>currentPage?'next':'prev');}});
      renderPage(1);
    });
  });
}

// === Drive 로그인 버튼 ===
$('#drive-login').click(handleClientLoad);
</script>
</body>
</html>

